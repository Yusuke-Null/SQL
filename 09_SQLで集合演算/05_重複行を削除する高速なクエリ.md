# 重複行を削除する高速なクエリ
自己結合の使い方で作成した主キーなしのChapter3ProductsDuplicatedを使って考える
|name|price|
|:----|:----|
|りんご|80|
|みかん|100|
|みかん|100|
|みかん|100|
|バナナ|50|

相関サブクエリでは以下の様になる(Oracleで考える)
``` sql
-- oracle
DELETE FROM Chapter3Products p1
WHERE rowid < (SELECT MAX(P2.rowid)
				 FROM
					Chapter3Products p2
				 WHERE
					p1.name = p2.name
				 AND
					p1.price = p2.price)

-- SQlServer
WITH Duplicates AS (
    SELECT *,
           ROW_NUMBER() OVER (PARTITION BY name, price ORDER BY (SELECT NULL)) AS rn
    FROM Chapter3Products
)
DELETE FROM Duplicates
WHERE rn > 1;
```
DELETEが時間がかかる処理に加えて、相関サブクエリのためパフォーマンスが難点  
上記クエリは{名前,値段}の組み合わせでまとめたときに、最大のrowidを求め、それ以外の行を削除している  

削除対象の行を直接求めるのは難しいため、より簡単な残す行を先に求め、それを全体から引く補集合の考え方で行う  
``` sql
DELETE FROM Chapter3Products
WHERE rowid IN(
	SELECT rowid --全体のrowid
	FROM
		Chapter3Products
	EXCEPT
	SELECT MAX(rowid) --残すべきrowid
	FROM
		Chapter3Products
	GROUP BY
		name
		,price)
```
テーブルのイメージは以下で定数リスト(2,3)を返す
rowid|name|price|
|:----|:----|:----|
|1|りんご|80|
|2|みかん|100|
|3|みかん|100|
|4|みかん|100|
|5|バナナ|50|

また、下記の様にNOT INでも表現できる  
パフォーマンスはテーブル規模や削除行の残す行比率によって変わるが  
EXCEPTを持っていない実装でも使える
``` sql
DELETE FROM Chapter3Products
WHERE rowid NOT IN(
	SELECT MAX(rowid)
	FROM
		Chapter3Products
	GROUP BY
		name
		,price)
```
