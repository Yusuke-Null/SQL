# 集合の相当性チェック
## テーブル同士のコンペア- 集合の相当性チェック基本編
DB環境を移行したり、バックアップと最新環境を比較するなど2つのテーブルが等しいかチェックしたい場合がある  
-> 等しいとは行数も列数もデータの内容も同じ = 集合として等しい

テーブル名が異なるだけで、等しいテーブル
| Chapter9Tbl_A |       |       |       |   | Chapter9Tbl_B |       |       |       |
|---------------|-------|-------|-------|---|----------------|-------|-------|-------|
| key_value     | col_1 | col_2 | col_3 |   | key_value      | col_1 | col_2 | col_3 |
| A             | 2     | 3     | 4     |   | A              | 2     | 3     | 4     |
| B             | 0     | 7     | 9     |   | B              | 0     | 7     | 9     |
| C             | 5     | 1     | 6     |   | C              | 5     | 1     | 6     |

EX) 以下のテーブルが等しいかを調べるSQL
UNIONを使って求める  
※ AとBの行数は同じであることを確認済みである前提
``` sql
SELECT COUNT(*) AS cnt FROM
(
	SELECT * FROM Chapter9Tbl_A
	UNION
	SELECT * FROM Chapter9Tbl_B
) AS tmp

-- result
cnt
3
```
事前に確認した行数と一致すればテーブル同士が相当と分かる  
反対にそれより大きければ相当でない  
-> **ALLを付けなければ重複行が排除されてきれいに重なり合うため  
さらに上記のクエリはテーブルにNULLがあっても正しく動作するに加え  
列数や列名、データ型を一切指定せずに使える**  

つまり、UNIONは任意のテーブルSについて、以下となる
> S UNION S = S

これを数学で冪等性と呼ぶ。簡単に言うと  
> 項演算子\*の任意の入力SについてS\*S=Sが成り立つ

プログラミングでは少し拡張して、「繰り返し処理を何度実行しても1度だけ実行した場合と結果が同じ」という意味で使う  
例えば、HTTPのGETコマンドが同じ要求を繰り返し発行しても安全になっているなど  
集合演算UNIONの場合はS UNION Sを1つの処理単位としてみれば何度実行しても結果は同じだから  
これも冪等と言える。つまり、3つ以上のテーブルでも等しいか比較することが可能  
ただし、UNION ALLは演算を繰り返す度に結果が変化するため、冪等性が成立しない  
同様に重複行を持ったテーブルに対してはUNIONは冪等性を失う  
よって多重集合の世界では通用しない = **主キーは重要である**

## テーブル同士のコンペア- 集合の相当性チェック応用編
EX) 2つのテーブル行を調べることなく、相当性チェックをしたい  
集合論では一般的に集合の相当性を調べる公式は以下の2つがある  
1. (A ⊆ B)かつ(A ⊇ B)⇔(A = B)
-> AがBを含み、かつBがAを含むなら両者は等しい
   
2. (A ∪ B)=(A ∩ B)⇔(A = B)
-> AがBに含まれていて、かつBがAに含むなら両者は等しい(A UNION B = A INTERSECT B)
「A UNION B = A = B」だけでなく「A INTERSECT B = A = B」でも成り立つ
→ INTERSECTにも冪等性が成立する
**反対にA≠BならUNIONとINTERSECTの結果は異なり、UNIONのほうが絶対に行数が多くなる**

AとBテーブルは常に(A INTERSECT B)⊆(A UNION B)であることが分かっている  
(A UNION B)EXCEPT(A INTERSECT B)が空集合かを判定すればよい  
A=Bの時に空集合となり、A≠Bの時に1行以上の行が残る
``` sql
SELECT
	CASE
		WHEN COUNT(*) = 0 THEN '等しい'
		ELSE '異なる'
	END AS result
FROM
	((SELECT * FROM Chapter9Tbl_A
	 UNION
	 SELECT * FROM Chapter9Tbl_B)
	EXCEPT
	SELECT * FROM Chapter9Tbl_A) AS tmp

-- result
result
等しい
```
