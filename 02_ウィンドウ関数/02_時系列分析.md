# 時系列分析
時系列に従って、1行ずつ過去へ遡るか、未来へ進むSQL  
Ex) サーバーの時間ごとの負荷量を記録したテーブルから過去の直近日付データを出力する  
PRECEDINGは前の行、FOLLOWINGは後の行
``` SQL
-- FOLLOWING
SELECT
	sample_date as cur_date
	,load_val as cur_load
	,MIN(sample_date) OVER (
		ORDER BY sample_date ASC
		ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING) AS latest_date
	,MIN(load_val) OVER (
		ORDER BY sample_date ASC
		ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING) AS latest_load
FROM
	Chapter2LoadSample

-- result
cur_date	cur_load	latest_date	latest_load
2018-02-01	1024	NULL	NULL
2018-02-02	2366	2018-02-01	1024
2018-02-05	2366	2018-02-02	2366
2018-02-07	985	2018-02-05	2366
2018-02-08	780	2018-02-07	985
2018-02-12	1000	2018-02-08	780

-- FOLLOWING
SELECT
	sample_date as cur_date
	,load_val as cur_load
	,MIN(sample_date) OVER (
		ORDER BY sample_date ASC
		ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING) AS latest_date
	,MIN(load_val) OVER (
		ORDER BY sample_date ASC
		ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING) AS latest_load
FROM
	Chapter2LoadSample

-- result
cur_date	cur_load	latest_date	latest_load
2018-02-01	1024	2018-02-02	2366
2018-02-02	2366	2018-02-05	2366
2018-02-05	2366	2018-02-07	985
2018-02-07	985	2018-02-08	780
2018-02-08	780	2018-02-12	1000
2018-02-12	1000	NULL	NULL
```

## 列の値に基づいたフレーム設定
RANGEを用いてデータ型にあった構文を使用しないといけない  
SQL ServerではROWSで指定するのが定石
- SQL Server の RANGE は ORDER BY に指定された列の「同値グループ」までしか対応していない
- 日付や数値のような「連続値」に対して RANGE BETWEEN INTERVAL '1' DAY PRECEDING のような指定は 構文エラーになる
下記のサンプルではsample_dateが連続値(ex 2018-02-01,2018-02-02のような場合)にday1_beforeが表示される(2018-02-02がカレントレコードなら2018-02-01が表示)
``` SQL
SELECT
	sample_date as cur_date
	,load_val as cur_load
	,MIN(sample_date) OVER (
		ORDER BY sample_date ASC
		RANGE BETWEEN INTERVAL '1' day PRECEDING AND INTERVAL '1' day PRECEDING) as day1_before
FROM
	Chapter2LoadSample
```

## フレーム句のオプション
- ROWS: 移動単位を行
- RANGE: 移動単位を列の値、基準はORDER BY句で指定した列
- n PRECEDING: nだけ前
- n FOLLOWING: nだけ後
- UNBOUNDED PRECEDING: 無制限で前
- UNBOUNDED FOLLOWING: 無制限で後
- CURRENT ROW: 現在行
