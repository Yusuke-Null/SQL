# ウィンドウ関数vs相関サブクエリ
- ウィンドウ関数
  - サブクエリを使っていても「相関サブクエリでない」
  - サブクエリ単体で実行可能なため、可読性が高く、動作の理解がしやすい
  - サブクエリ内部だけを実行することで、デバッグも簡単
  - テーブルスキャンも一度だけパフォーマンスが良い
- 相関サブクエリ
  - 常に複数のテーブルを結合するSQLの古い機能によって行間比較を実現
 
ウィンドウ関数の方が簡単に読み書き出来てパフォーマンスがよい  
この違いは相関サブクエリの複数テーブル(自己結合で物理的なテーブルであっても)を結合するに対して  
ウィンドウ関数は行の順序に基づいた手続き型言語のループの動作をダイレクトにSQLに持ち込んでいるため  

## なぜウィンドウ関数で相関サブクエリを置き換えられるのか
ポイントは集合(テーブルの)のカットの動作
|item_id|item_name|item_category|sale_price|
|:----|:----|:----|:----|
|0001|Tシャツ|衣服|1000|
|0002|穴あけパンチ|事務用品|500|
|0003|カッターシャツ|衣服|4000|
|0004|包丁|キッチン用品|3000|
|0005|圧力鍋|キッチン用品|6800|
|0006|フォーク|キッチン用品|500|
|0007|おろしがね|キッチン用品|880|
|0008|ボールペン|事務用品|100|

EX) 各商品分類について、平均単価より高い商品を求める  
相関サブクエリ  
``` sql
SELECT
	item_name
	,item_category
	,sale_price
FROM
	Chapter7Items AS i1
WHERE
	sale_price > (
		SELECT
			AVG(i2.sale_price)
		FROM
			Chapter7Items AS i2
		WHERE
			i1.item_category = i2.item_category
		GROUP BY
			i2.item_category)
ORDER BY
	item_category
	,sale_price

-- result
item_name	item_category	sale_price
包丁	キッチン用品	3000
圧力鍋	キッチン用品	6800
カッターシャツ	衣服	4000
穴あけパンチ	事務用品	500
```
商品分類が同じレコードに限定して、その集合の平均単価と各レコードの販売単価を1行ずつ比較する  
-> SELECT文を１行ずつループの様に繰り返し実行しているのと同じ動作をしている
> 1行ずつ評価する
> -> 行数分だけ、毎度平均単価を取得する相関サブクエリが実行されるからパフォーマンスが悪い
> Tシャツの判定
> WHERE 1000 > 2500
> 穴あけパンチの判定
> WHERE 500 > 300
