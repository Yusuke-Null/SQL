# オーバーラップ
とある宿の1室の予約状況を表したテーブル
|reserver|checkin_date|checkout_date|
|:----|:----|:----|
|木村|2018-10-26|2018-10-27|
|荒木|2018-10-28|2018-10-31|
|堀|2018-10-31|2018-11-01|
|山本|2018-11-03|2018-11-04|
|内田|2018-11-03|2018-11-05|
|水谷|2018-11-06|2018-11-06|

EX) オーバーラップ(重複)した客をリスト化する
重複パターンは以下の3つ
1. チェックイン日が他の宿泊期間内である
2. チェックアウト日が他の宿泊期間内である
3. 宿泊期間が他の宿泊期間内に完全に入っている  
-> 1と2が満たしているのと同じなので考えなくてよい

相関サブクエリ
``` sql
SELECT
	reserver
	,checkin_date
	,checkout_date
FROM
	Chapter7Reservations AS r1
WHERE
	EXISTS(
		SELECT * FROM Chapter7Reservations AS r2
		WHERE
			r1.reserver <> r2.reserver
		AND
		(
			(r2.checkin_date <= r1.checkin_date AND r1.checkin_date <= r2.checkout_date)
			OR
			(r2.checkin_date <= r1.checkout_date AND r1.checkout_date <= r2.checkout_date)
		)
	)

-- result
reserver	checkin_date	checkout_date
荒木	2018-10-28	2018-10-31
堀	2018-10-31	2018-11-01
山本	2018-11-03	2018-11-04
内田	2018-11-03	2018-11-05
```
ウィンドウ関数
``` sql
SELECT
	reserver
	,next_reserver
	,checkin_date
	,checkout_date
	,next_checkin_date
FROM
	(SELECT
		checkin_date
		,checkout_date
		,reserver
		,MAX(reserver) OVER (ORDER BY checkin_date ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING) AS next_reserver
		,MAX(checkin_date) OVER (ORDER BY checkin_date ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING) AS next_checkin_date
	 FROM
		Chapter7Reservations) AS tmp
WHERE
	checkin_date <= next_checkin_date
AND
	next_checkin_date <= checkout_date

-- result
reserver	next_reserver	checkin_date	checkout_date	next_checkin_date
荒木	堀	2018-10-28	2018-10-31	2018-10-31
山本	内田	2018-11-03	2018-11-04	2018-11-03
```

水谷のcheckin_dateを早めたテーブル
|reserver|checkin_date|checkout_date|
|:----|:----|:----|
|木村|2018-10-26|2018-10-27|
|荒木|2018-10-28|2018-10-31|
|堀|2018-10-31|2018-11-01|
|山本|2018-11-03|2018-11-04|
|内田|2018-11-03|2018-11-05|
|水谷|2018-11-04|2018-11-06|

同様のsqlを実行すると以下のようになる
``` sql
-- result-相関サブクエリ
reserver	checkin_date	checkout_date
荒木	2018-10-28	2018-10-31
堀	2018-10-31	2018-11-01
山本	2018-11-03	2018-11-04
内田	2018-11-03	2018-11-05
水谷	2018-11-04	2018-11-06

-- result-ウィンドウ関数
reserver	next_reserver	checkin_date	checkout_date	next_checkin_date
荒木	堀	2018-10-28	2018-10-31	2018-10-31
山本	内田	2018-11-03	2018-11-04	2018-11-03
内田	水谷	2018-11-03	2018-11-05	2018-11-04
```
相関サブクエリは重複があることが分かる一方、ウィンドウ関数では誰と重複しているか分かる  
※ 2人以上と重複している場合は2列のみ出力にはなるため、そこまでは分からないが  
さらにチェックインとチェックアウトが同日の場合、相関サブクエリだと、他の期間と接触しなくなるため  
重複があっても表示されなくなる  
例えば、山本のチェックイン日が11/4の場合は内田の期間と接触がなくなり、内田がリストから消える
