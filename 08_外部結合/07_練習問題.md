# 練習問題
## 8-1
03_クロス表で入れ子の表側を作るで以下のクエリを使用した。  
しかし、パフォーマンス的には中間ビューを2度使うのは良くないため、減らしたい
``` sql
SELECT
	master.age_class AS age_class
	,master.sex_cd AS sex_cd
	,data.pop_tohoku AS pop_tohoku
	,data.pop_kanto AS pop_kanto
FROM
	(SELECT
		age_class
		,sex_cd
	 FROM
		Chapter8TblAge
	 CROSS JOIN
		Chapter8TblSex) AS master
LEFT JOIN
	(SELECT
		age_class
		,sex_cd
		,SUM(CASE
				WHEN pref_name IN('青森','秋田') THEN population
				ELSE NULL
				END) AS pop_tohoku
		,SUM(CASE
				WHEN pref_name IN('東京','千葉') THEN population
				ELSE NULL
				END) AS pop_kanto
	FROM
		Chapter8TblPop
	GROUP BY
		age_class
		,sex_cd) AS data
ON
	master.age_class = data.age_class
AND
	master.sex_cd = data.sex_cd
ORDER BY
	master.age_class
```
結果
|age_class|sex_cd|pop_tohoku|pop_kanto|
|:----|:----|:----|:----|
|1|f|1300|2500|
|1|m|1100|1800|
|2|f|NULL|NULL|
|2|m|NULL|NULL|
|3|f|1800|2100|
|3|m|1000|NULL|

以下の様にして中間ビュー減らす
``` sql
SELECT
	master.age_class AS age_class
	,master.sex_cd AS sex_cd
	,SUM(CASE
			WHEN data.pref_name IN('青森','秋田') THEN population
			ELSE NULL
			END) AS pop_tohoku
	,SUM(CASE
			WHEN data.pref_name IN('東京','千葉') THEN population
			ELSE NULL
			END) AS pop_kanto
FROM
	(SELECT
		age_class
		,sex_cd
	 FROM
		Chapter8TblAge
	 CROSS JOIN
		Chapter8TblSex) AS master
LEFT JOIN
	Chapter8TblPop AS data
ON
	master.age_class = data.age_class
AND
	master.sex_cd = data.sex_cd
GROUP BY
	master.age_class
	,master.sex_cd
ORDER BY
	master.age_class
```
マスタについては変えようがないため。性別と年齢階級のクロス表を作る  
これが人口構成テーブルと1:Nの関係になるので行数を変えずに外部結合できる

## 8-2
02_外部結合で行列変換 > 列→行: 繰り返し項目を1列にまとめるでは  
以下のクエリで社員ごとの子供の一覧を求めたが  
社員が子供を何人扶養しているかのクエリに修正すること
``` sql
SELECT
	emp.employee
	,children.child
FROM
	Chapter8Personnel AS emp
LEFT JOIN
	Chapter8Children AS children
ON
	children.child IN(emp.child1,emp.child2,emp.child3)
WHERE
	children.child IS NOT NULL
ORDER BY
	emp.employee
```
結果
|employee|child|
|:----|:----|
|工藤|夏子|
|工藤|春子|
|赤井|二郎|
|赤井|一郎|
|赤井|三郎|
|鈴木|夏子|

解答は次のようになる
``` sql
SELECT
	emp.employee
	,COUNT(children.child) AS child_cnt
FROM
	Chapter8Personnel AS emp
LEFT JOIN
	Chapter8Children AS children
ON
	children.child IN(emp.child1,emp.child2,emp.child3)
GROUP BY
	emp.employee
ORDER BY
	child_cnt

-- result
employee	child_cnt
吉田	0
鈴木	1
工藤	2
赤井	3
```
ポイントはCOUNT(*)はNULLも含めて行をカウントするため、COUNT(列名)を使用すること

# 8-3
完全外部結合は情報を欠落させない点はMERTGE文と似ている  
MERGE文は2つのテーブルの情報を1か所にまとめることができるため  
入力元のデータソースが複数に分散していて、それを1つにまとめたい場合などで活躍する  

05_完全外部結合で使用したテーブルをコピーして使用する(太文字が元と変わっている)  
Class_B2のデータをClass_A2へマージする  
idをキーにClassA2を検索し、行があればUPATEし、なければINSERTする。  
つまり、処理する内容は以下である
- たまたま名前が一致した田中とBクラスにはいない伊集院は変更なし
- id2は内海に更新
- Aクラスにいない西園寺を追加する

| Class_A2 |       |   | Class_B2 |       |
|--------|--------|---|--------|--------|
| id     | name   |   | id     | name   |
| 1      | 田中   |   | 1      | 田中   |
| 2      | 鈴木   |   | 2      | **内海**   |
| 3      | 伊集院 |   | 4      | 西園寺 |

