# 外部結合で集合演算
結合は集合演算とみなすことができ、完全外部結合(UNION)は和集合であり、内部結合は積集合である  
情報が欠落しないという点ではUNIONと外部結合は似ている  

## 左(右)外部結合で差集合を求める
### 外部結合で差集合を求める: A-B
UNIONのような集合演算子はパフォーマンスの影響があるため、集合演算子の代用案をマスターしておくことは有用  
先のClass_AとClass_Bの外部結合クエリでは、Aに存在しないまたはBに存在しない値はNULLとなっていた  
-> 結合結果に対してNULLの条件を設定することで差集合を求められる  
下記はAクラスに存在し、Bクラスには存在しない人を求める
``` sql
SELECT
	a.id AS id
	,a.name AS a_name 
	,b.name AS b_name
FROM
	Chapter8Class_A AS a
LEFT JOIN
	Chapter8Class_B AS b
ON
	a.id = b.id
WHERE
	b.name IS NULL

--result
id	a_name	b_name
3	伊集院	NULL
```
### 外部結合で差集合を求める: B-A
前述の反対でBクラスに存在し、Aクラスに孫座しない人を求める  
(BをFROM句に持ってきて、LEFTJOINでもOK)
``` sql
SELECT
	a.id AS id
	,a.name AS a_name 
	,b.name AS b_name
FROM
	Chapter8Class_A AS a
RIGHT JOIN
	Chapter8Class_B AS b
ON
	a.id = b.id
WHERE
	a.name IS NULL

-- result
id	a_name	b_name
NULL	NULL	西園寺
```
外部結合の使い方としては正道ではないが、差集合演算を持っていない実装の場合には  
NOT INやNOT EXISTSと並んで現実的な選択肢である(差集合演算の中では最速の動作である可能性が高いため)

## 完全外部結合で排他的和集合を求める
集合Aと集合Bの排他的和集合を求める演算子がSQLにはない  
集合演算子を使うなら以下どちらかになるが、面倒かつパフォーマンスが悪い
``` sql
-- AとBの和集合からAとBの積集合を除く
(A UNION B) EXCEPT(A INTERSECT B)
-- AからBを除いたものとBからAを除いたものを合わせる
(A EXCEPT B) UNION(B EXCEPT A)
```
完全外部結合のNULLの条件を設定すれば求められる
``` sql
SELECT
	COALESCE(a.id,b.id) AS id
	,COALESCE(a.name,b.name) AS name 
FROM
	Chapter8Class_A AS a
FULL JOIN
	Chapter8Class_B AS b
ON
	a.id = b.id
WHERE
	a.name IS NULL
OR
	b.name IS NULL

-- result
id	name
3	伊集院
4	西園寺
```

和、差、交差に加えて商も外部結合でできる  
HAVING句の章で学んだ関係除算を外部結合で書ける  
| 販売テーブル |       |   | 商品マスタ |       |
|--------------|--------|---|------------|--------|
| shop         | item   |   | item       |        |
| 仙台         | ビール |   | ビール     |        |
| 仙台         | 紙おむつ |   | 紙おむつ   |        |
| 仙台         | 自転車 |   | 自転車     |        |
| 仙台         | カーテン |   |            |        |
| 東京         | ビール |   |            |        |
| 東京         | 紙おむつ |   |            |        |
| 東京         | 自転車 |   |            |        |
| 大阪         | テレビ |   |            |        |
| 大阪         | 紙おむつ |   |            |        |
| 大阪         | 自転車 |   |            |        |
``` sql
-- Q.商品マスタに登録されたもの全てを仕入れている店舗を求める
-- HAVING句で使用したクエリ
SELECT s1.shop FROM Chapter6ShopItems as s1
INNER JOIN
	Chapter6Items as i
ON
	s1.item = i.item
GROUP BY
	s1.shop
HAVING
	COUNT(s1.item) = (SELECT COUNT(item) FROM Chapter6Items)

-- 外部結合
SELECT DISTINCT s1.shop FROM Chapter6ShopItems as s1
WHERE
	NOT EXISTS(
		SELECT
			i.item
		FROM
			Chapter6Items AS i
		LEFT JOIN
			Chapter6ShopItems AS s2
		ON
			i.item = s2.item
		AND
			s1.shop = s2.shop
		WHERE
			s2.shop IS NULL)

-- result
shop
仙台
東京
```
外部結合のクエリの意味は以下
- Itemsから店舗ごとの商品を引き算した結果が空集合であれば全ての商品がある
- s1.shop = s2.shopの相関サブクエリで店舗ごとの条件を記述
→ WHERE句に書くと結果に大阪まで含まれる
検索条件のWHERE句より結合条件ON句の方が先に実行され、店舗関係なくitemでしか比較されず
WHERE句に大阪まで渡してしまう
つまり、結合条件として、商品名(item)とshop(店舗)が同じであるとしないといけない
