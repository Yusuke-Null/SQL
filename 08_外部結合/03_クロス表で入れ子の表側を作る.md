# クロス表で入れ子の表側を作る
| 人口構成テーブル       |           |        |        |   | 性別マスタ |       |   | 年齢階級マスタ |           |
|------------------------|-----------|--------|--------|---|------------|-------|---|----------------|-----------|
| pref_name              | age_class | sex_cd | population |   | sex_cd     | sex   |   | age_class      | age_range |
| 秋田                   | 1         | m      | 400        |   | f          | 女    |   | 1              | 21～30歳   |
| 秋田                   | 3         | m      | 1000       |   | m          | 男    |   | 2              | 31～40歳   |
| 秋田                   | 1         | f      | 800        |   |            |       |   | 3              | 41～50歳   |
| 秋田                   | 3         | f      | 1000       |   |            |       |   |                |           |
| 青森                   | 1         | m      | 700        |   |            |       |   |                |           |
| 青森                   | 1         | f      | 500        |   |            |       |   |                |           |
| 青森                   | 3         | f      | 800        |   |            |       |   |                |           |
| 東京                   | 1         | m      | 900        |   |            |       |   |                |           |
| 東京                   | 1         | f      | 1500       |   |            |       |   |                |           |
| 東京                   | 3         | f      | 1200       |   |            |       |   |                |           |
| 千葉                   | 1         | m      | 900        |   |            |       |   |                |           |
| 千葉                   | 1         | f      | 1000       |   |            |       |   |                |           |
| 千葉                   | 3         | f      | 900        |   |            |       |   |                |           |

EX) 上記から表側を入れ子にした表を出力したい(人口構成テーブルには年齢階級2はないが、2も出力する)  
単純に外部結合するだけではうまくいかない
``` sql
SELECT
	master1.age_class AS age_class
	,data.sex_cd AS sex_cd
	,data.pop_tohoku AS pop_tohoku
	,data.pop_kanto AS pop_kanto
FROM
	(SELECT
		age_class
		,sex_cd
		,SUM(CASE
				WHEN pref_name IN('青森','秋田') THEN population
				ELSE NULL
				END) AS pop_tohoku
		,SUM(CASE
				WHEN pref_name IN('東京','千葉') THEN population
				ELSE NULL
				END) AS pop_kanto
	 FROM
		Chapter8TblPop
	 GROUP BY
		age_class
		,sex_cd) AS data
RIGHT JOIN
	Chapter8TblAge AS master1
ON
	master1.age_class = data.age_class
RIGHT JOIN
	Chapter8TblSex AS master2
ON
	master2.sex_cd = data.sex_cd
ORDER BY
	data.age_class

-- result
age_class	sex_cd	pop_tohoku	pop_kanto
1	f	1300	2500
1	m	1100	1800
3	m	1000	NULL
3	f	1800	2100
```
上記では年齢階級2の行が外部結合なのに出力されない  
下記のSQLでは年齢階級マスタまでの外部結合であり、2の行まで出力される
``` sql
SELECT
	master1.age_class AS age_class
	,data.sex_cd AS sex_cd
	,data.pop_tohoku AS pop_tohoku
	,data.pop_kanto AS pop_kanto
FROM
	(SELECT
		age_class
		,sex_cd
		,SUM(CASE
				WHEN pref_name IN('青森','秋田') THEN population
				ELSE NULL
				END) AS pop_tohoku
		,SUM(CASE
				WHEN pref_name IN('東京','千葉') THEN population
				ELSE NULL
				END) AS pop_kanto
	 FROM
		Chapter8TblPop
	 GROUP BY
		age_class
		,sex_cd) AS data
RIGHT JOIN
	Chapter8TblAge AS master1
ON
	master1.age_class = data.age_class
ORDER BY
	data.age_class

-- result
age_class	sex_cd	pop_tohoku	pop_kanto
2	NULL	NULL	NULL
1	f	1300	2500
1	m	1100	1800
3	f	1800	2100
3	m	1000	NULL
```
年齢階級マスタまで外部結合した際に年齢階級2が出力されない理由は以下である
1. 年齢階級マスタとの外部結合時点では年齢階級2の他の値はNULLとなる
2. 1より性別マスタとの外部結合時は年齢階級2の性別はNULLで結合しようとする
3. 性別はm,fもなく、「master2.sex_cd = NULL」となり、結果はunknownとなり、表示されない

よって正しく表側を入れ子するには以下の様に考えればよい  
つまり、外部結合を2度することができないのであれば、1度ですませばよい
``` sql
SELECT
	master.age_class AS age_class
	,master.sex_cd AS sex_cd
	,data.pop_tohoku AS pop_tohoku
	,data.pop_kanto AS pop_kanto
FROM
	(SELECT
		age_class
		,sex_cd
	 FROM
		Chapter8TblAge
	 CROSS JOIN
		Chapter8TblSex) AS master
LEFT JOIN
	(SELECT
		age_class
		,sex_cd
		,SUM(CASE
				WHEN pref_name IN('青森','秋田') THEN population
				ELSE NULL
				END) AS pop_tohoku
		,SUM(CASE
				WHEN pref_name IN('東京','千葉') THEN population
				ELSE NULL
				END) AS pop_kanto
	FROM
		Chapter8TblPop
	GROUP BY
		age_class
		,sex_cd) AS data
ON
	master.age_class = data.age_class
AND
	master.sex_cd = data.sex_cd
ORDER BY
	master.age_class

-- result
age_class	sex_cd	pop_tohoku	pop_kanto
1	f	1300	2500
1	m	1100	1800
2	f	NULL	NULL
2	m	NULL	NULL
3	f	1800	2100
3	m	1000	NULL
```
性別マスタと年齢階級マスタのクロス表を作れば一度のビューへの外部結合で済む  
-> **表側を入れ子にするときはその形のマスタをあらかじめ用意すればよい**
