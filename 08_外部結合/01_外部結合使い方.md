# 外部結合使い方
SQLは帳票を作成することもできるが、本来の用途でない結果のフォーマット成形までを求められる  
SQL自体はあくまでもデータ検索を目的に作られた言語である

## 外部結合行列変換-クロス表
|name|course|
|:----|:----|
|赤井|SQL入門|
|赤井|UNIX基礎|
|鈴木|SQL入門|
|工藤|SQL入門|
|工藤|Java中級|
|吉田|UNIX基礎|
|渡辺|SQL入門|

EX) 各コースの受講者のクロス表を作る  
|name|SQL入門|UNIX基礎|Java中級|
|:----|:----|:----|:----|
|吉田|NULL|〇|NULL|
|工藤|〇|NULL|〇|
|赤井|〇|〇|NULL|
|渡辺|〇|NULL|NULL|
|鈴木|〇|NULL|NULL|

見た目が異なるだけで誰が何の講座を受講したかのデータは既に存在しているため  
本来SQLがするべき仕事はない
``` sql
SELECT
	c0.name
	,CASE
		WHEN c1.name IS NOT NULL THEN '〇'
		ELSE NULL
	END AS 'SQL入門'
	,CASE
		WHEN c2.name IS NOT NULL THEN '〇'
		ELSE NULL
	END AS 'UNIX基礎'
	,CASE
		WHEN c3.name IS NOT NULL THEN '〇'
		ELSE NULL
	END AS 'Java中級'
FROM
	(SELECT DISTINCT name FROM Chapter8Courses) AS c0
LEFT JOIN
	(SELECT name FROM Chapter8Courses WHERE course = 'SQL入門') AS c1
ON
	c0.name = c1.name
LEFT JOIN
	(SELECT name FROM Chapter8Courses WHERE course = 'UNIX基礎') AS c2
ON
	c0.name = c2.name
LEFT JOIN
	(SELECT name FROM Chapter8Courses WHERE course = 'Java中級') AS c3
ON
	c0.name = c3.name
```
SQLで名前を与えればテーブルもビューも等しく集合として存在することになる  
-> サブクエリによって4つの集合を作成している  
ただし、インラインビュー(FROM句で使うサブクエリのこと)と結合を多用するため  
コードが長大になるに加え、必要な列が増えればパフォーマンスが悪くなる

一般的に外部結合はスカラサブクエリで代用できる
``` sql
SELECT
	c0.name
	,(SELECT '〇' FROM Chapter8Courses AS C1
		WHERE
			course = 'SQL入門'
		AND
			c0.name = c1.name) AS 'SQL入門'
	,(SELECT '〇' FROM Chapter8Courses AS C2
		WHERE
			course = 'UNIX基礎'
		AND
			c0.name = c2.name
	) AS 'Java中級'
	,(SELECT '〇' FROM Chapter8Courses AS C3
		WHERE
			course = 'Java中級'
		AND
			c0.name = c3.name
	) AS 'Java中級'
FROM
	(SELECT name FROM Chapter8Courses) AS c0
```
スカラサブクエリを使えば、列の増減があってもSELECT句の中だけ修正すればよい  
一方、スカラサブクエリであり相関サブクエリであるため、パフォーマンスがよくない  
-> **SELECTに返された1行ずつに実行されるため**

CASE式を入れ子にすることでも表現できる  
``` sql
SELECT
	name
	,CASE
		WHEN SUM(
			CASE
				WHEN course = 'SQL入門' THEN 1
				ELSE NULL
			END) = 1 THEN '〇'
		ELSE NULL
	END AS 'SQL入門'
	,CASE
		WHEN SUM(
			CASE
				WHEN course = 'UNIX基礎' THEN 1
				ELSE NULL
			END) = 1 THEN '〇'
		ELSE NULL
	END AS 'UNIX基礎'
	,CASE
		WHEN SUM(
			CASE
				WHEN course = 'Java中級' THEN 1
				ELSE NULL
			END) = 1 THEN '〇'
		ELSE NULL
	END AS 'Java中級'
FROM
	Chapter8Courses
GROUP BY
	name
```
慣れれば簡潔で、修正範囲もSELECT句のみであるし  
SELECT句では集約関数もスカラ値に評価されるため、定数や列と同じように扱えると考えると理解しやすい
