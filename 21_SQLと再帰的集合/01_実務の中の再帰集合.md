# 実務の中の再帰集合
03_自己結合の使い方でRANK関数を使わず、自己非当直結合でランキングを算出するSQLや  
相関サブクエリを求めるクエリの礎となっている考え方はフォンノイマンによる再帰集合を使った自然数の定義である  
``` sql
-- 相関サブクエリ
SELECT
	p1.name
	,p1.price
	,(SELECT COUNT(p2.price)
		FROM Chapter3Products p2
		WHERE p1.price < p2.price) + 1 as price_rank
FROM
	Chapter3Products p1
ORDER BY
	p1.price DESC

-- self join
SELECT
	p1.name
	,MAX(p1.price) as price
	,COUNT(p2.name) + 1 as rank_1
FROM
	Chapter3Products p1
LEFT JOIN
	Chapter3Products p2
ON
	p1.price < p2.price
GROUP BY
	p1.name
ORDER BY
	price DESC

-- result
name	price	price_rank
みかん	100	1
バナナ	100	1
いちご	100	1
スイカ	80	4
ぶどう	50	5
りんご	50	5
レモン	30	7

SELECT
	p1.name
	,p1.price
	,(SELECT COUNT(DISTINCT p2.price)
		FROM Chapter3Products p2
		WHERE p1.price < p2.price) + 1 as price_rank
FROM
	Chapter3Products p1
ORDER BY
	p1.price DESC

-- result
name	price	price_rank
みかん	100	1
バナナ	100	1
いちご	100	1
スイカ	80	2
ぶどう	50	3
りんご	50	3
レモン	30	4
```
SQLが集合論と密接に結びついていることを示す好例だが  
ノイマンはなぜ自然数を集合で定義しようとしたのかの疑問があり、歴史的な観点から見ていく
