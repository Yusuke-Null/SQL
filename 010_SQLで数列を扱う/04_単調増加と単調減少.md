# 単調増加と単調減少
順序集合は数だけでなく、日付でもできる
|deal_date|price|
|:----|:----|
|2018-01-06|1000|
|2018-01-08|1050|
|2018-01-09|1050|
|2018-01-12|900|
|2018-01-13|880|
|2018-01-14|870|
|2018-01-16|920|
|2018-01-17|1000|
|2018-01-18|2000|

Q. 株価が単調増加している期間を求める  
最初のステップとして特定の取引日の株価が上昇しているかを考える  
``` sql
SELECT
	deal_date
	,price
	,CASE SIGN(
		price - MAX(price) OVER(
			ORDER BY deal_date
			ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING))
		WHEN 1 THEN 'up'
		WHEN 0 THEN 'stay'
		WHEN -1 THEN 'down'
		ELSE NULL
	END AS diff
FROM
	Chapter10MyStock

-- result
deal_date	price	diff
2018-01-06	1000	NULL
2018-01-08	1050	up
2018-01-09	1050	stay
2018-01-12	900	down
2018-01-13	880	down
2018-01-14	870	down
2018-01-16	920	up
2018-01-17	1000	up
2018-01-18	2000	up
```
SIGN関数は引数に取った数値が正なら1、0なら0、負なら-1を返す  
コードの見通しをよくするため、upのレコードだけに限定し、昇順の連番をふったビューを作成する
``` sql
CREATE VIEW Chapter10MyStockUpSeq(deal_date,price,row_num) AS
SELECT
	deal_date
	,price
	,row_num
FROM
	(SELECT
		deal_date
		,price
		,CASE SIGN(
			price - MAX(price) OVER(
				ORDER BY deal_date
				ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING))
			WHEN 1 THEN 'up'
			WHEN 0 THEN 'stay'
			WHEN -1 THEN 'down'
			ELSE NULL
		END AS diff
		,ROW_NUMBER() OVER(
			ORDER BY deal_date) AS row_num
	FROM
		Chapter10MyStock) AS tmp
WHERE
	diff = 'up'

-- result
deal_date	price	row_num
2018-01-08	1050	2
2018-01-16	920	7
2018-01-17	1000	8
2018-01-18	2000	9
```
ビューのrow_numを使って、自己結合を利用しながら連続するシーケンスのグループを作成する
``` sql
SELECT
	MIN(deal_date) AS deal_start_date
	,'~'
	,MAX(deal_date) AS deal_end_date
FROM
	(SELECT
		m1.deal_date
		,COUNT(m2.row_num) - MIN(m1.row_num) AS gap
	 FROM
		Chapter10MyStockUpSeq AS m1
	 INNER JOIN
		Chapter10MyStockUpSeq AS m2
	 ON
		m2.row_num <= m1.row_num
	 GROUP BY
		m1.deal_date) tmp
GROUP BY
	gap

-- result
deal_start_date	(列名なし)	deal_end_date
2018-01-16	~	2018-01-18
2018-01-08	~	2018-01-08
```
gap列のの値によってシーケンスをグループ化している  
グループ内の取引日の最小値と最大値がそのまま始点と終点になる  
結合部分だけ抜き出すと以下のようになる
``` sql
SELECT
	m1.deal_date
	,m2.row_num AS m2_row_num
	,m1.row_num AS m1_row_num
FROM
	Chapter10MyStockUpSeq AS m1
INNER JOIN
	Chapter10MyStockUpSeq AS m2
ON
	m2.row_num <= m1.row_num
ORDER BY
	m1.deal_date

-- result
deal_date	m2_row_num	m1_row_num
2018-01-08	2	2
2018-01-16	2	7
2018-01-16	7	7
2018-01-17	2	8
2018-01-17	7	8
2018-01-17	8	8
2018-01-18	2	9
2018-01-18	7	9
2018-01-18	8	9
2018-01-18	9	9
```
つまり、日付や文字列といったデータ型が問題なのではなく  
順序を持っていることが本質的である。  
-> 順序があれば、その項目のソートキーとしてROW_NUMBER()を使って数列に変換できるから
