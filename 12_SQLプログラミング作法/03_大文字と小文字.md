# 大文字と小文字
プログラミングでは重要な語句を大文字、そうでない語句は小文字で書く習慣がある  
SQLの場合は予約が大文字、列名やテーブル名は小文字(要素後の頭文字は大文字の派閥もある)という共通理解が成立している  
なお、SQLにおいて大文字と小文字の区別は見た目上の違いしかなく、DBMS内ではどちらも同じと扱われる

### カンマ
**カンマは要素と要素の中間に置く**  
下記のような書き方のメリットは以下
- col_3を削除してもエラーにならずそのまま使える
- カンマがどの行でも同じ列位置に来るため、短形選択の機能を持つエディタでの編集がやりやすい
反対にデメリットは可読性を下げること
``` sql
SELECT col_1
  ,col_2
  ,col_3
FROM tbl_A
```

### ワイルドカードは使わない
ワイルドカード(*)はテーブルの全列を選択するが、あまり使わない方が良い理由は以下
- 論理的には不要な列まで含まれるため、可読性の低下や仕様変更に弱い
- 結果の形式が列の並び順に左右されるため、列順の入れ替えや追加削除が発生した時に結果が狂う原因になる
そのため、SELECT句には必要な列だけを指定する
ただし、このことは原則であり、例えば100列ある必要な場合では全て指定すると逆に可読性が下がるため、ケースバイケースで対応が必要

### ORDER BYで列番号は使わない
ORDER BY句のソートのキー列として実際の列名の代わりに列番号を指定できる  
可読性は悪くなるに加え、SQL-92では将来削除されるべき機能のリストに含まれている  
そのため、保守性の観点からも使用しない方が良い  
**ワイルドカードもそうだが、SQLは順序や位置に左右される書き方は極力排除することが鉄則**
``` sql
-- 良い例
SELECT col_1, col_2
FROM tbl_A
ORDER BY
	col_1, col_2

-- 悪い例
SELECT col_1, col_2
FROM tbl_A
ORDER BY
	1,2
```

## 標準語を話す
SQLは方言も多く、各実装が特色ある拡張をしてくれているが、あまり統一感のある努力はされていない  
歴史的に標準SQLが貧弱で、各ベンダが独自拡張で不足を補わないといけない背景があった  
近年は標準SQLも整備が進み、実用性も大幅に向上したため、DBMS間のコード移植ができるよう標準語で話すようにする

### 実装依存の関数や演算子を使わない
実装依存の関数が特に乱立しているのは変換関数や文字列操作周り  
DECODE(Oracle), IF(MySQL),NVL(Oracle),STUFF(SQL Server)等、は使わないこと  
CASE式やCOALSECE、NULLIFといった標準語を使う  
また、SIGNやABS、REPLACEのように標準SQLではないが、ほぼすべての実装で使えるなら実害がないため使用してもよい  
ただ、悩ましいのは標準SQLでありながら実装状況にばらつきがある機能である  
日付関数のEXTRACT、文字列連結の||演算子やPOSITION関数等は使用頻度は高いが、互換性が低下する

### 結合には標準の構文を使う
SQLの文法で最も実装依存の度合いが高いのが結合構文  
かつては結合条件は検索条件と区別せずにWHERE句に書いていたが  
標準SQLでは結合条件はON句に分離して書くことになっている  
``` sql
-- かつての結合の書き方
SELECT * FROM Foo F,Bar B
WHERE F.state = B.state
```
ON句を使うことで結合条件を書き忘れてCROSS JOINになることが防止できる  
また、外部結合は「LEFT OUTER JOIN」のように内部結合に対して外部結合であると伝えるためにOUTERを付けて書く  
さらに結合条件としてOracleでは「(+)」、SQL Serverでは「*=」という演算子があるがこれも使わないこと

### 左派と右派
外部結合(左、右、完全)の内、左と右の表現力は同じなため、論理的にはどちらを使ってもよいことになる  
しかし、左外部結合は結果の表側は当然左に来るため、左のテーブルにマスタを持ってくることでSQLと結果のイメージがリンクする  

### 相関サブクエリを追放せよ
SQLは昔から「NULLに量化、相関サブクエリ」がつまずきポイントとされてきた  
NULLと量化はSQLの本質に深く根差した使用であるが、相関サブクエリは高確率で手放すことが可能になった  
その手法の1つがウィンドウ関数で、可読性もパフォーマンスも向上するため、採用しない理由がない  
相関サブクエリは書くのもデバッグも大変に加え、サブクエリを単体で実行できないため、デバッグを脳内でやることになる  
ウィンドウ関数であれば、サブクエリ化しても非相関であるため、簡単に小さい単位で実行できる

### FROM句から書く
SELECT句はSQLが大きく複雑になるほど時間のかかる分かりづらい方法になる  
-> SELECT句がSQLの中で最後に実行される部分であるから  
SQLの実行順序は以下である
1. FROM
2. WHERE
3. GROUP BY
4. HAVING
5. SELECT
6. (ORDER BY)
-> SELECT句で付けた列の別名をGROUP BY句で参照できないのは、SELECTが最後であり、まだその別名が作られていないため
とはいえ、CASE式を駆使して許可するDBもあるが
つまり、SELECT句は表示用に見た目を整形したり、計算列を算出したりするだけなのでロジックを考える時は無視してよい
WHERE、GROUP BY、HAVINGの方が重要な役割を持っているため、複雑なSQLを書くときはFROM句から書いた方が自然なロジックを追える

## まとめ
長期的に見れば、パフォーマンスよりも可読性を重視した方が良い  
パフォーマンスはマシンパワーやDBの性能が向上すれば、小手先のテクニックを使わなくても解決の見込みがあるが  
**読みにくいコードは何物も、誰も解決してくれない**
