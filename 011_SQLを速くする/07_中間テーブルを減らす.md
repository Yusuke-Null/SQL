# 中間テーブルを減らす
SQLではサブクエリの結果を新たなテーブルとみなして  
あたかもオリジナルのテーブルと同じようにコードの中で扱うことができる  
しかし、中間テーブルを不要にたくさん使うとパフォーマンス低下の原因となる  
中間テーブルの問題点はデータを展開する為にメモリ(場合によってはストレージ)を消費することと  
元テーブルに存在したインデックスを使用するのが難しくなる(特に集約した場合)

### HAVING句を活用する
集約結果への条件にはHAVING句を使って設定するのが原則  
-> 中間テーブルを作ってWHERE句に頼らない
``` sql
-- 中間テーブル
SELECT * FROM (
	SELECT sale_date,MAX(quantity) AS max_qty
	FROM Chapter8SalesHistory
	GROUP BY
		sale_date) AS tmp
WHERE
	10 <= max_qty
-- result
sale_date	max_qty
2018-10-01	10
2018-10-03	32
2018-10-04	22
```
集約結果に対する条件はわざわざ中間テーブルを作らなくてもHAVINGで設定できる
``` sql
SELECT sale_date,MAX(quantity) AS max_qty FROM Chapter8SalesHistory
GROUP BY
	sale_date
HAVING
	10 <= MAX(quantity)

-- result
sale_date	max_qty
2018-10-01	10
2018-10-03	32
2018-10-04	22
```
HAVING句は集約を行いながら並行して動作するため、中間テーブル作成後に実行されるWHERE句より効率的でコードも簡潔

### IN述語で複数のキーを利用する場合、一か所にまとめる
=,<,>のような比較述語やIN述語にスカラ値でなく値のリストを取ることが可能  
``` sql
-- 複数サブクエリを使用
SELECT id, state, city FROM Addresses1 AS a1
WHERE
	state IN(
		SELECT state FROM Addresses1 AS a2
		WHERE
			a1.id = a2.id)
AND
	city IN(
		SELECT city FROM Addresses1 AS a2
		WHERE
			a1.id = a2.id)
```
上記はサブクエリを複数使っているが、キーを結合して1つにすれば、ロジックを一か所にまとめられる
※ ||は文字連結であり、SQL Serverでは+になる -> 意図しない一致が発生するため非推奨
``` sql
SELECT * FROM Addresses AS a1
WHERE
	id || state || city IN(
		SELECT id || state || city FROM Addresses AS a2)
```
サブクエリを悲相関にできるうえ、検索回数も一度で済む  
行比較サポートをしているDBなら、列のペアをINの引数にとるようにも書ける  
文字列の結合に比べて、結合時に型変換を気にしなく良いに加え、列に加工しないためインデックスが利用できる
※ SQL Serverではエラー
``` sql
SELECT * FROM Addresses AS a1
WHERE
	(id,state,city) IN(
		SELECT id,state,city FROM Addresses AS a2)
```

### 集約よりも結合を先に行う
集約よりも先に結合を行うことで、中間テーブルを省略できる  
-> 集合演算としての結合が掛け算として機能するため  
一対一または一対多の関係が保たれている場合は、結合によって行数が増えない  
通常の設計であれば、多対多の関係は関連エンティティによって2つの一対多の関係に分解されているため  
ほとんどの場合でこのテクニックが利用できる  
Chapter8の外部結合の使い方でも触れている

### ビューを計画的に利用する
安易に複雑なビューを定義すると、パフォーマンスでは大きなマイナスになる  
特にビュー定義のクエリに以下のような演算が含まれている場合
非効率的なSQLとなり、思わぬ速度低下を招くことがある
- 集約関数(AVG, COUNT, SUM, MAX, MIN)
- 集合演算子(UNION, INTERSECT, EXCEPT...etc)

**基本的にビューで集約をしていたら要注意**ということ  
上記のビューの欠点を補うために*マテリアライズドビューの技術を実装したDBMSも増えている  
※ クエリの結果を実体的なデータとして保存しているため、性能特定はほとんどテーブルと同じ  
ただし、ストレージ容量を消費し、データの同期生には注意が必要だが、ビューに比べてパフォーマンスが向上する  
SQL Serverにはなく、インデックス付きビューが提供されている　　
